[2025-07-25 14:28:30] === Démarrage du déploiement de test pour budget-app ===
[2025-07-25 14:28:30] MongoDB est déjà installé
[2025-07-25 14:28:30] Création de l'environnement virtuel...
[2025-07-25 14:28:30] Environnement virtuel activé: /Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/venv/bin/python
[2025-07-25 14:28:30] Mise à jour de pip...
Traceback (most recent call last):
  File "/Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/venv/bin/pip", line 7, in <module>
    from pip._internal.cli.main import main
ModuleNotFoundError: No module named 'pip._internal'
[2025-07-25 14:28:30] Installation des dépendances...
Traceback (most recent call last):
  File "/Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/venv/bin/pip", line 7, in <module>
    from pip._internal.cli.main import main
ModuleNotFoundError: No module named 'pip._internal'
[2025-07-25 14:28:30] Installation des dépendances depuis requirements.txt...
Traceback (most recent call last):
  File "/Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/venv/bin/pip", line 7, in <module>
    from pip._internal.cli.main import main
ModuleNotFoundError: No module named 'pip._internal'
[2025-07-25 14:28:30] Vérification des modules installés...
Modules installés avec succès!
[2025-07-25 14:28:31] PYTHONPATH configuré: /Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend:
[2025-07-25 14:28:31] Exécution des tests...
============================= test session starts ==============================
platform darwin -- Python 3.13.0, pytest-8.0.0, pluggy-1.6.0 -- /Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/venv/bin/python
cachedir: .pytest_cache
rootdir: /Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend
plugins: anyio-4.9.0, asyncio-0.23.6
asyncio: mode=Mode.STRICT
collecting ... collected 0 items / 2 errors

==================================== ERRORS ====================================
___________________ ERROR collecting app/tests/test_auth.py ____________________
ImportError while importing test module '/Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/app/tests/test_auth.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/opt/homebrew/Cellar/python@3.13/3.13.0_1/Frameworks/Python.framework/Versions/3.13/lib/python3.13/importlib/__init__.py:88: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
app/tests/test_auth.py:13: in <module>
    from app.db.models import UserModel
E   ImportError: cannot import name 'UserModel' from 'app.db.models' (/Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/app/db/models.py)
_______________ ERROR collecting app/tests/test_transactions.py ________________
ImportError while importing test module '/Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/app/tests/test_transactions.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/opt/homebrew/Cellar/python@3.13/3.13.0_1/Frameworks/Python.framework/Versions/3.13/lib/python3.13/importlib/__init__.py:88: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
app/tests/test_transactions.py:8: in <module>
    from app.db.models import TransactionModel, CategoryModel, UserModel
E   ImportError: cannot import name 'TransactionModel' from 'app.db.models' (/Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/app/db/models.py)
=============================== warnings summary ===============================
venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:323: 10 warnings
  /Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:923
venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:923
venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:923
venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:923
venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:923
venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:923
  /Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:923: PydanticDeprecatedSince20: `__get_validators__` is deprecated and will be removed, use `__get_pydantic_core_schema__` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warn(

venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:298
venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:298
venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:298
venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:298
venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:298
venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:298
  /Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/venv/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:298: PydanticDeprecatedSince20: `json_encoders` is deprecated. See https://docs.pydantic.dev/2.11/concepts/serialization/#custom-serializers for alternatives. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(

venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:373
  /Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:373: UserWarning: Valid config keys have changed in V2:
  * 'orm_mode' has been renamed to 'from_attributes'
    warnings.warn(message, UserWarning)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
ERROR app/tests/test_auth.py
ERROR app/tests/test_transactions.py
!!!!!!!!!!!!!!!!!!! Interrupted: 2 errors during collection !!!!!!!!!!!!!!!!!!!!
======================== 23 warnings, 2 errors in 1.25s ========================
[2025-07-25 14:28:32] ATTENTION: Les tests ont échoué. Vérifiez les erreurs dans le log.
[2025-07-25 14:28:32] Chargement des données de test dans MongoDB...
Inséré 1 utilisateurs
Inséré 4 catégories
Inséré 10 transactions
Données de test chargées avec succès dans MongoDB
[2025-07-25 14:28:33] Arrêt des instances précédentes...
[2025-07-25 14:28:33] Aucune instance précédente trouvée
[2025-07-25 14:28:33] Démarrage de l'application...
[2025-07-25 14:28:33] Répertoire courant: /Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend
[2025-07-25 14:28:33] Contenu du répertoire courant: total 240
drwxr-xr-x@  4 tonyauge  staff    128 Jul 24 13:59 __pycache__
drwxr-xr-x@ 24 tonyauge  staff    768 Jul 25 14:27 .
drwxr-xr-x@ 11 tonyauge  staff    352 Jul 25 14:28 ..
-rw-r--r--@  1 tonyauge  staff    440 Jul 23 10:35 .env.example
drwxr-xr-x@  6 tonyauge  staff    192 Jul 25 09:58 .pytest_cache
drwxr-xr-x@ 14 tonyauge  staff    448 Jul 25 10:06 app
-rw-r--r--@  1 tonyauge  staff   4666 Jul 25 14:28 backend_debug.log
-rw-r--r--@  1 tonyauge  staff   7432 Jul 25 14:28 backend_deploy.log
-rw-r--r--@  1 tonyauge  staff  13754 Jul 25 11:08 backend_log.log
-rw-r--r--@  1 tonyauge  staff    424 Jul 25 10:42 check_users.py
-rw-r--r--@  1 tonyauge  staff   5650 Jul 25 10:43 create_transactions.py
-rw-r--r--@  1 tonyauge  staff   1332 Jul 25 10:42 create_user.py
-rw-r--r--@  1 tonyauge  staff   7432 Jul 25 14:28 deploy_output.log
-rw-r--r--@  1 tonyauge  staff    109 Jul 25 12:53 deploy_test.log
-rwxr-xr-x@  1 tonyauge  staff  20066 Jul 25 12:37 deploy_test.sh
-rw-r--r--@  1 tonyauge  staff   1363 Jul 25 10:44 fix_categories.py
-rw-r--r--@  1 tonyauge  staff   1777 Jul 25 10:46 fix_dates.py
-rw-r--r--@  1 tonyauge  staff   1116 Jul 25 10:45 fix_transactions.py
-rw-r--r--@  1 tonyauge  staff    297 Jul 24 13:59 requirements.txt
-rwxr-xr-x@  1 tonyauge  staff   1331 Jul 24 14:31 stop_test.sh
-rw-r--r--@  1 tonyauge  staff   5398 Jul 24 12:33 test_data.json
-rw-r--r--@  1 tonyauge  staff    942 Jul 24 12:28 test_password.py
drwxr-xr-x@  7 tonyauge  staff    224 Jul 25 11:36 venv
-rw-r--r--@  1 tonyauge  staff    416 Jul 25 10:42 view_users.py
[2025-07-25 14:28:33] Contenu du répertoire app: total 24
-rw-r--r--@  1 tonyauge  staff   103 Jul 25 09:52 __init__.py
drwxr-xr-x@  4 tonyauge  staff   128 Jul 25 09:58 __pycache__
drwxr-xr-x@ 14 tonyauge  staff   448 Jul 25 10:06 .
drwxr-xr-x@ 24 tonyauge  staff   768 Jul 25 14:27 ..
drwxr-xr-x@  5 tonyauge  staff   160 Jul 24 11:11 core
drwxr-xr-x@  5 tonyauge  staff   160 Jul 25 09:58 db
drwxr-xr-x@  7 tonyauge  staff   224 Jul 24 14:06 interceptors
-rw-r--r--@  1 tonyauge  staff  4837 Jul 25 09:42 main.py
drwxr-xr-x@  5 tonyauge  staff   160 Jul 25 10:04 models
drwxr-xr-x@  9 tonyauge  staff   288 Jul 25 10:06 routers
drwxr-xr-x@  6 tonyauge  staff   192 Jul 24 12:18 schemas
drwxr-xr-x@  7 tonyauge  staff   224 Jul 24 14:39 services
drwxr-xr-x@  3 tonyauge  staff    96 Jul 24 21:25 static
drwxr-xr-x@  5 tonyauge  staff   160 Jul 25 09:49 tests
[2025-07-25 14:28:33] Contenu du répertoire app/main.py: from fastapi import FastAPI, Depends, HTTPException, status
from fastapi.middleware.cors import CORSMiddleware
from contextlib import asynccontextmanager
import logging

from app.core.config import settings
from app.db.mongodb import mongodb, get_db
from app.db.models import create_indexes
from app.routers import auth, users, transactions, categories, reports
from app.interceptors import setup_interceptors

# Configuration du logger
logger = logging.getLogger("budget-api")

@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    Gestionnaire de cycle de vie de l'application.
    Se connecte à MongoDB au démarrage et ferme la connexion à l'arrêt.
    """
[2025-07-25 14:28:33] PYTHONPATH avant lancement: /Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend:
[2025-07-25 14:28:33] Uvicorn démarré avec PID 80540 et PYTHONPATH=/Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend:
INFO:     Will watch for changes in these directories: ['/Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend']
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [80540] using StatReload
/Users/tonyauge/Library/Mobile Documents/com~apple~CloudDocs/Code/budget/backend/venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:373: UserWarning: Valid config keys have changed in V2:
* 'orm_mode' has been renamed to 'from_attributes'
  warnings.warn(message, UserWarning)
INFO:     Started server process [80550]
INFO:     Waiting for application startup.
2025-07-25 14:28:33,867 - budget-api - INFO - Démarrage de l'application - Connexion à MongoDB...
2025-07-25 14:28:33,867 - budget-api - INFO - Tentative de connexion à MongoDB: mongodb://localhost:27017
2025-07-25 14:28:33,876 - budget-api - INFO - Vérification de la connexion MongoDB avec ping...
2025-07-25 14:28:33,877 - pymongo.serverSelection - INFO - {"message": "Waiting for suitable server to become available", "selector": "Primary()", "operation": "ping", "topologyDescription": "<TopologyDescription id: 68837871ab711f66262ee1e1, topology_type: Unknown, servers: [<ServerDescription ('localhost', 27017) server_type: Unknown, rtt: None>]>", "clientId": {"$oid": "68837871ab711f66262ee1e1"}, "remainingTimeMS": 4}
2025-07-25 14:28:33,879 - budget-api - INFO - ✅ Connecté à MongoDB - Base de données: budget_db
2025-07-25 14:28:33,879 - budget-api - INFO - Création des index pour les collections MongoDB...
2025-07-25 14:28:33,913 - budget-api - INFO - Index créés avec succès.
2025-07-25 14:28:33,965 - budget-api - INFO - Ajout de 7 catégories par défaut
2025-07-25 14:28:33,973 - budget-api - INFO - Vérification des collections terminée avec succès
2025-07-25 14:28:33,973 - budget-api - INFO - Application démarrée avec succès - MongoDB connecté
INFO:     Application startup complete.
2025-07-25 14:28:34,278 - budget-api - INFO - {"correlation_id": "187622a5-0845-4ba0-81f9-ac585de45a56", "client_ip": "127.0.0.1", "method": "GET", "path": "/docs", "query_params": {}, "user_agent": "curl/8.7.1", "timestamp": "2025-07-25T12:28:34.278068+00:00", "status_code": 200, "processing_time_ms": 0.42, "level": "INFO"}
Connecté à MongoDB - budget_db
INFO:     127.0.0.1:54000 - "GET /docs HTTP/1.1" 200 OK
[2025-07-25 14:28:36] Application démarrée avec PID 80540
[2025-07-25 14:28:36] Vous pouvez accéder à l'API à http://localhost:8000
[2025-07-25 14:28:36] Documentation Swagger disponible à http://localhost:8000/docs
[2025-07-25 14:28:36] Surveillance du démarrage de l'application pendant 5 secondes...
2025-07-25 14:28:37,270 - budget-api - INFO - {"correlation_id": "e53e4036-afbd-46f5-92c4-2c0a8540cd6c", "client_ip": "127.0.0.1", "method": "GET", "path": "/docs", "query_params": {}, "user_agent": "curl/8.7.1", "timestamp": "2025-07-25T12:28:37.270581+00:00", "status_code": 200, "processing_time_ms": 0.31, "level": "INFO"}
INFO:     127.0.0.1:54008 - "GET /docs HTTP/1.1" 200 OK
[2025-07-25 14:28:41] Vérification de la réponse de l'API...
2025-07-25 14:28:41,471 - budget-api - INFO - {"correlation_id": "5e8e5084-325e-4769-9841-95b61e606988", "client_ip": "127.0.0.1", "method": "GET", "path": "/docs", "query_params": {}, "user_agent": "curl/8.7.1", "timestamp": "2025-07-25T12:28:41.471668+00:00", "status_code": 200, "processing_time_ms": 0.18, "level": "INFO"}
INFO:     127.0.0.1:54023 - "GET /docs HTTP/1.1" 200 OK
200[2025-07-25 14:28:41] L'API répond correctement
[2025-07-25 14:28:41] Pour arrêter l'application manuellement, exécutez: kill 80540
[2025-07-25 14:28:41] Le fichier stop_test.sh existe déjà, pas de modification
[2025-07-25 14:28:41] Déploiement de test terminé avec succès
2025-07-25 14:28:43,266 - budget-api - WARNING - {"correlation_id": "9dabf8e6-ad87-4fd8-8e51-cc6f5cbcecb6", "client_ip": "127.0.0.1", "method": "OPTIONS", "path": "/api/health", "query_params": {}, "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15", "timestamp": "2025-07-25T12:28:43.266290+00:00", "status_code": 400, "processing_time_ms": 0.47, "level": "WARNING"}
INFO:     127.0.0.1:54026 - "OPTIONS /api/health HTTP/1.1" 400 Bad Request
2025-07-25 14:28:48,626 - budget-api - WARNING - {"correlation_id": "105f4d89-cd1e-4261-827b-0baf67a949cf", "client_ip": "127.0.0.1", "method": "OPTIONS", "path": "/api/health", "query_params": {}, "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15", "timestamp": "2025-07-25T12:28:48.626318+00:00", "status_code": 400, "processing_time_ms": 0.37, "level": "WARNING"}
INFO:     127.0.0.1:54031 - "OPTIONS /api/health HTTP/1.1" 400 Bad Request
2025-07-25 14:29:00,491 - budget-api - INFO - {"correlation_id": "15ff237d-48be-4f55-84dd-48eac355153b", "client_ip": "127.0.0.1", "method": "GET", "path": "/docs", "query_params": {}, "user_agent": "curl/8.7.1", "timestamp": "2025-07-25T12:29:00.490946+00:00", "status_code": 200, "processing_time_ms": 0.32, "level": "INFO"}
INFO:     127.0.0.1:54035 - "GET /docs HTTP/1.1" 200 OK
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2025-07-25 14:49:03,456 - budget-api - INFO - Arrêt de l'application - Fermeture de la connexion MongoDB...
2025-07-25 14:49:03,477 - budget-api - INFO - Connexion MongoDB fermée
2025-07-25 14:49:03,477 - budget-api - INFO - Connexion MongoDB fermée avec succès
INFO:     Application shutdown complete.
INFO:     Finished server process [80550]
Connexion MongoDB fermée
INFO:     Stopping reloader process [80540]
